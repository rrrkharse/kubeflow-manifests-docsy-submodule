<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.80.0" />
<meta name="robots" content="index, follow">

<script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "WebSite",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "\/"
      },
      "articleSection" : "docs",
      "name" : "EFS",
      "headline" : "EFS",
      "description" : "Use Amazon EFS as persistent storage with Kubeflow on AWS",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "0001",
      "datePublished": "0001-01-01 00:00:00 \u002b0000 UTC",
      "dateModified" : "0001-01-01 00:00:00 \u002b0000 UTC",
      "url" : "\/docs\/deployment\/install\/add-ons\/storage\/efs\/guide\/",
      "wordCount" : "2554",
      "keywords" : [ "Kubeflow" ]
  }
  </script>

<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="manifest" href="/favicons/manifest.json">
<meta name="msapplication-config" content="/favicons/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#4279f4">
<meta name="theme-color" content="#4279f4">

<title>EFS | Kubeflow on AWS</title>
<meta name="description" content="Use Amazon EFS as persistent storage with Kubeflow on AWS">
<meta property="og:title" content="EFS" />
<meta property="og:description" content="Use Amazon EFS as persistent storage with Kubeflow on AWS" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/deployment/install/add-ons/storage/efs/guide/" />
<meta property="article:modified_time" content="2022-04-19T18:52:20-07:00" /><meta property="og:site_name" content="Kubeflow on AWS" />
<meta itemprop="name" content="EFS">
<meta itemprop="description" content="Use Amazon EFS as persistent storage with Kubeflow on AWS">
<meta itemprop="dateModified" content="2022-04-19T18:52:20-07:00" />
<meta itemprop="wordCount" content="2554">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="EFS"/>
<meta name="twitter:description" content="Use Amazon EFS as persistent storage with Kubeflow on AWS"/>




<link rel="preload" href="/scss/main.min.85f1a9dbca421adb85ef71deab25ace09331a89d47e3aafe98fe498adc786a6d.css" as="style">
<link href="/scss/main.min.85f1a9dbca421adb85ef71deab25ace09331a89d47e3aafe98fe498adc786a6d.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-135379910-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand-md navbar-dark  td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Kubeflow on AWS</span>
	</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_navbar" aria-controls="main_navbar" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse ml-md-auto" id="main_navbar">
		<ul class="navbar-nav ml-auto pt-4 pt-md-0 my-2 my-md-1">
			
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><i class='fas fa-book pr-2'></i><span>Documentation</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/awslabs/kubeflow-manifests" target="_blank" ><i class='fab fa-github pr-2'></i><span>GitHub</span></a>
			</li>
			
			
			<li class="nav-item dropdown mt-1 mt-lg-0 mr-2">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Releases
</a>
<div class="dropdown-menu dropdown-menu-md-right dropdown-menu-lg-left" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://awslabs.github.io/kubeflow-manifests/docs">1.4</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <input type="search" class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav foldable-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsabout-li">
  <input type="checkbox" id="m-docsabout-check"/>
  <label for="m-docsabout-check"><a href="/docs/about/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsabout"><span class="">About</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsaboutfeatures-li">
  <input type="checkbox" id="m-docsaboutfeatures-check"/>
  <label for="m-docsaboutfeatures-check"><a href="/docs/about/features/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsaboutfeatures"><span class="">AWS Features for Kubeflow</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsaboutreleases-li">
  <input type="checkbox" id="m-docsaboutreleases-check"/>
  <label for="m-docsaboutreleases-check"><a href="/docs/about/releases/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsaboutreleases"><span class="">Releases and Versioning</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsabouteks-compatibility-li">
  <input type="checkbox" id="m-docsabouteks-compatibility-check"/>
  <label for="m-docsabouteks-compatibility-check"><a href="/docs/about/eks-compatibility/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsabouteks-compatibility"><span class="">Amazon EKS and Kubeflow Compatibility</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsaboutsecurity-li">
  <input type="checkbox" id="m-docsaboutsecurity-check"/>
  <label for="m-docsaboutsecurity-check"><a href="/docs/about/security/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsaboutsecurity"><span class="">Security</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsaboutusage-tracking-li">
  <input type="checkbox" id="m-docsaboutusage-tracking-check"/>
  <label for="m-docsaboutusage-tracking-check"><a href="/docs/about/usage-tracking/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsaboutusage-tracking"><span class="">Usage Tracking</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsdeployment-li">
  <input type="checkbox" id="m-docsdeployment-check" checked/>
  <label for="m-docsdeployment-check"><a href="/docs/deployment/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsdeployment"><span class="">Deployment</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsdeploymentinstall-li">
  <input type="checkbox" id="m-docsdeploymentinstall-check" checked/>
  <label for="m-docsdeploymentinstall-check"><a href="/docs/deployment/install/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsdeploymentinstall"><span class="">Install Kubeflow</span></a></label>
  
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallprerequisites-li">
  <input type="checkbox" id="m-docsdeploymentinstallprerequisites-check"/>
  <label for="m-docsdeploymentinstallprerequisites-check"><a href="/docs/deployment/install/prerequisites/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallprerequisites"><span class="">Prerequisites</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallcognitoguide-li">
  <input type="checkbox" id="m-docsdeploymentinstallcognitoguide-check"/>
  <label for="m-docsdeploymentinstallcognitoguide-check"><a href="/docs/deployment/install/cognito/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallcognitoguide"><span class="">Cognito</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallrds-s3guide-li">
  <input type="checkbox" id="m-docsdeploymentinstallrds-s3guide-check"/>
  <label for="m-docsdeploymentinstallrds-s3guide-check"><a href="/docs/deployment/install/rds-s3/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallrds-s3guide"><span class="">RDS and S3</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallcognito-rds-s3guide-li">
  <input type="checkbox" id="m-docsdeploymentinstallcognito-rds-s3guide-check"/>
  <label for="m-docsdeploymentinstallcognito-rds-s3guide-check"><a href="/docs/deployment/install/cognito-rds-s3/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallcognito-rds-s3guide"><span class="">Cognito, RDS, and S3</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallvanillaguide-li">
  <input type="checkbox" id="m-docsdeploymentinstallvanillaguide-check"/>
  <label for="m-docsdeploymentinstallvanillaguide-check"><a href="/docs/deployment/install/vanilla/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallvanillaguide"><span class="">Vanilla Installation</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsdeploymentinstalladd-ons-li">
  <input type="checkbox" id="m-docsdeploymentinstalladd-ons-check" checked/>
  <label for="m-docsdeploymentinstalladd-ons-check"><a href="/docs/deployment/install/add-ons/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsdeploymentinstalladd-ons"><span class="">Add-ons</span></a></label>
  
  <ul class="ul-4 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsdeploymentinstalladd-onsstorageefsguide-li">
  <input type="checkbox" id="m-docsdeploymentinstalladd-onsstorageefsguide-check" checked/>
  <label for="m-docsdeploymentinstalladd-onsstorageefsguide-check"><a href="/docs/deployment/install/add-ons/storage/efs/guide/" class="align-left pl-0  active td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstalladd-onsstorageefsguide"><span class="td-sidebar-nav-active-item">EFS</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstalladd-onsstoragefsx-for-lustreguide-li">
  <input type="checkbox" id="m-docsdeploymentinstalladd-onsstoragefsx-for-lustreguide-check"/>
  <label for="m-docsdeploymentinstalladd-onsstoragefsx-for-lustreguide-check"><a href="/docs/deployment/install/add-ons/storage/fsx-for-lustre/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstalladd-onsstoragefsx-for-lustreguide"><span class="">FSx for Lustre</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstalladd-onscloudwatchguide-li">
  <input type="checkbox" id="m-docsdeploymentinstalladd-onscloudwatchguide-check"/>
  <label for="m-docsdeploymentinstalladd-onscloudwatchguide-check"><a href="/docs/deployment/install/add-ons/cloudwatch/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstalladd-onscloudwatchguide"><span class="">CloudWatch</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstalladd-onsload-balancerguide-li">
  <input type="checkbox" id="m-docsdeploymentinstalladd-onsload-balancerguide-check"/>
  <label for="m-docsdeploymentinstalladd-onsload-balancerguide-check"><a href="/docs/deployment/install/add-ons/load-balancer/guide/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstalladd-onsload-balancerguide"><span class="">Load Balancer</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentinstallcognitoreadme-automated-li">
  <input type="checkbox" id="m-docsdeploymentinstallcognitoreadme-automated-check"/>
  <label for="m-docsdeploymentinstallcognitoreadme-automated-check"><a href="/docs/deployment/install/cognito/readme-automated/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentinstallcognitoreadme-automated"><span class=""></span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsdeploymentuninstall-kubeflow-li">
  <input type="checkbox" id="m-docsdeploymentuninstall-kubeflow-check"/>
  <label for="m-docsdeploymentuninstall-kubeflow-check"><a href="/docs/deployment/uninstall-kubeflow/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsdeploymentuninstall-kubeflow"><span class="">Uninstall Kubeflow</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docscomponent-guides-li">
  <input type="checkbox" id="m-docscomponent-guides-check"/>
  <label for="m-docscomponent-guides-check"><a href="/docs/component-guides/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docscomponent-guides"><span class="">Component Guides</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscomponent-guidesnotebooks-li">
  <input type="checkbox" id="m-docscomponent-guidesnotebooks-check"/>
  <label for="m-docscomponent-guidesnotebooks-check"><a href="/docs/component-guides/notebooks/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscomponent-guidesnotebooks"><span class="">Notebooks</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscomponent-guidespipelines-li">
  <input type="checkbox" id="m-docscomponent-guidespipelines-check"/>
  <label for="m-docscomponent-guidespipelines-check"><a href="/docs/component-guides/pipelines/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscomponent-guidespipelines"><span class="">Pipelines</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscomponent-guideskserve-li">
  <input type="checkbox" id="m-docscomponent-guideskserve-check"/>
  <label for="m-docscomponent-guideskserve-check"><a href="/docs/component-guides/kserve/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscomponent-guideskserve"><span class="">KServe</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscomponent-guidesprofiles-li">
  <input type="checkbox" id="m-docscomponent-guidesprofiles-check"/>
  <label for="m-docscomponent-guidesprofiles-check"><a href="/docs/component-guides/profiles/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscomponent-guidesprofiles"><span class="">Profiles</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docstroubleshooting-aws-li">
  <input type="checkbox" id="m-docstroubleshooting-aws-check"/>
  <label for="m-docstroubleshooting-aws-check"><a href="/docs/troubleshooting-aws/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docstroubleshooting-aws"><span class="">Troubleshooting</span></a></label>
  
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/awslabs/kubeflow-manifests/docs/tree/master/content/en/docs/deployment/install/add-ons/storage/efs/guide.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa fa-file-alt fa-fw"></i> View page source</a>
  <a href="https://github.com/awslabs/kubeflow-manifests/docs/edit/master/content/en/docs/deployment/install/add-ons/storage/efs/guide.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
  <a href="https://github.com/awslabs/kubeflow-manifests/docs/new/master/content/en/docs/deployment/install/add-ons/storage/efs/guide.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> Create child page</a>
  <a href="https://github.com/awslabs/kubeflow-manifests/docs/issues/new?title=EFS" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
  <a href="https://github.com/awslabs/kubeflow-manifests/issues/new" class="td-page-meta--project-issue" target="_blank" rel="noopener"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
  
</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#10-prerequisites">1.0 Prerequisites</a></li>
    <li><a href="#20-setup-efs">2.0 Setup EFS</a>
      <ul>
        <li><a href="#21-option-1-automated-setup">2.1 [Option 1] Automated setup</a></li>
        <li><a href="#22-option-2-manual-setup">2.2 [Option 2] Manual setup</a></li>
      </ul>
    </li>
    <li><a href="#30-using-efs-storage-in-kubeflow">3.0 Using EFS Storage in Kubeflow</a>
      <ul>
        <li><a href="#31-set-up-the-environment">3.1 Set up the environment</a></li>
        <li><a href="#32-changing-the-default-storage-class">3.2 Changing the default Storage Class</a></li>
        <li><a href="#33-note-about-permissions">3.3 Note about Permissions</a></li>
        <li><a href="#34-creating-and-using-efs-volumes-as-workspace-or-data-volume-for-a-notebook-dynamic-provisioning">3.4 Creating and using EFS volumes as workspace or data volume for a notebook (Dynamic Provisioning)</a></li>
        <li><a href="#35-using-existing-efs-volume-as-workspace-or-data-volume-for-a-notebook-static-provisioning">3.5 Using existing EFS volume as workspace or data volume for a notebook (Static Provisioning)</a></li>
        <li><a href="#36-using-efs-volume-for-a-trainingjob-using-tfjob-operator">3.6 Using EFS volume for a TrainingJob using TFJob Operator</a></li>
      </ul>
    </li>
    <li><a href="#40-cleanup">4.0 Cleanup</a>
      <ul>
        <li><a href="#41-clean-up-the-tfjob">4.1 Clean up the TFJob</a></li>
        <li><a href="#42-delete-the-kubeflow-notebook">4.2 Delete the Kubeflow Notebook</a></li>
        <li><a href="#43-delete-pvc-pv-and-sc-in-the-following-order">4.3 Delete PVC, PV and SC in the following order</a></li>
        <li><a href="#44-delete-the-efs-mount-targets-filesystem-and-security-group">4.4 Delete the EFS mount targets, filesystem and security group</a></li>
      </ul>
    </li>
    <li><a href="#50-known-issues">5.0 Known Issues:</a></li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/docs/">Documentation</a>
  </li>
  <li class="breadcrumb-item">
    <a href="/docs/deployment/">Deployment</a>
  </li>
  <li class="breadcrumb-item">
    <a href="/docs/deployment/install/">Install Kubeflow</a>
  </li>
  <li class="breadcrumb-item">
    <a href="/docs/deployment/install/add-ons/">Add-ons</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="/docs/deployment/install/add-ons/storage/efs/guide/">EFS</a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>EFS</h1>
	<div class="lead">Use Amazon EFS as persistent storage with Kubeflow on AWS</div>
	<header class="article-meta">
		

  
    


  
    


  

		
	</header>    
	<p>This guide describes how to use Amazon EFS as Persistent storage on top of an existing Kubeflow deployment.</p>
<h2 id="10-prerequisites">1.0 Prerequisites</h2>
<ol>
<li>For this README, we will assume that you already have an EKS Cluster with Kubeflow installed since the EFS CSI Driver can be installed and configured as a separate resource on top of an existing Kubeflow deployment. You can follow any of the other guides to complete these steps - choose one of the <a href="../../../README.md#deployment-options">AWS managed service integrated offering</a> or <a href="../../../vanilla/README.md">vanilla distribution</a>.</li>
</ol>
<p><strong>Important :</strong>
You must make sure you have an <a href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC provider</a> for your cluster and that it was added from <code>eksctl</code> &gt;= <code>0.56</code> or if you already have an OIDC provider in place, then you must make sure you have the tag <code>alpha.eksctl.io/cluster-name</code> with the cluster name as its value. If you don&rsquo;t have the tag, you can add it via the AWS Console by navigating to IAM-&gt;Identity providers-&gt;Your OIDC-&gt;Tags.</p>
<ol start="2">
<li>At this point, you have likely cloned this repo and checked out the right branch. Let&rsquo;s save this path to help us naviagte to different paths in the rest of this doc -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export GITHUB_ROOT=$(pwd)
</code></pre></div><ol start="3">
<li>Make sure the following environment variables are set.</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export CLUSTER_NAME=&lt;clustername&gt;
export CLUSTER_REGION=&lt;clusterregion&gt;
</code></pre></div><h2 id="20-setup-efs">2.0 Setup EFS</h2>
<p>You can either use Automated or Manual setup to set up the resources required. If you choose the manual route, you get another choice between static and dynamic provisioning, so pick whichever suits you. On the other hand, for the automated script we currently only support dynamic provisioning. Whichever combination you pick, be sure to continue picking the appropriate sections through the rest of this guide.</p>
<h3 id="21-option-1-automated-setup">2.1 [Option 1] Automated setup</h3>
<p>The script automates all the manual resource creation steps but is currently only available for Dynamic Provisioning option.<br>
It performs the required cluster configuration, creates an EFS file system and it also takes care of creating a storage class for dynamic provisioning. Once done, move to section 3.0.</p>
<ol>
<li>Run the following commands from the <code>tests/e2e</code> directory as -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">cd $GITHUB_ROOT/tests/e2e
</code></pre></div><ol start="2">
<li>Install the script dependencies</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">pip install -r requirements.txt
</code></pre></div><ol start="3">
<li>Run the automated script as follows. You can skip specifying the <code>efs_file_system_name</code> and <code>efs_security_group_name</code> if you are running the command for the first time in your account and want to use default values -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export FILESYSTEM_NAME=&lt;fs_name&gt;
export SG_NAME=&lt;sg_name&gt;

python utils/auto-efs-setup.py --region $CLUSTER_REGION --cluster $CLUSTER_NAME --efs_file_system_name $FILESYSTEM_NAME --efs_security_group_name $SG_NAME
</code></pre></div><h4 id="advanced-customization"><strong>Advanced customization</strong></h4>
<p>The script applies some default values for the file system name, performance mode etc. If you know what you are doing, you can see which options are customizable by executing <code>python utils/auto-efs-setup.py --help</code>.</p>
<h3 id="22-option-2-manual-setup">2.2 [Option 2] Manual setup</h3>
<p>If you prefer to manually setup each components then you can follow this manual guide.  As mentioned, it you have two options between Static and Dynamic provisioing later in step 4 of this section.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query &#34;Account&#34; --output text)
</code></pre></div><h4 id="1-install-the-efs-csi-driver">1. Install the EFS CSI Driver</h4>
<p>We recommend installing the EFS CSI Driver v1.3.4 directly from the <a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver">the aws-efs-csi-driver github repo</a> as follows -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -k &#34;github.com/kubernetes-sigs/aws-efs-csi-driver/deploy/kubernetes/overlays/stable/?ref=tags/v1.3.4&#34;
</code></pre></div><p>You can confirm that EFS CSI Driver was installed into the default kube-system namespace for you. You can check using the following command -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl get csidriver

NAME              ATTACHREQUIRED   PODINFOONMOUNT   MODES        AGE
efs.csi.aws.com   false            false            Persistent   5d17h
</code></pre></div><h4 id="2-create-the-iam-policy-for-the-csi-driver">2. Create the IAM Policy for the CSI Driver</h4>
<p>The CSI driver&rsquo;s service account (created during installation) requires IAM permission to make calls to AWS APIs on your behalf. Here, we will be annotating the Service Account <code>efs-csi-controller-sa</code> with an IAM Role which has the required permissions.</p>
<ol>
<li>Download the IAM policy document from GitHub as follows -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">curl -o iam-policy-example.json https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/v1.3.4/docs/iam-policy-example.json
</code></pre></div><ol start="2">
<li>Create the policy -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">aws iam create-policy \
    --policy-name AmazonEKS_EFS_CSI_Driver_Policy \
    --policy-document file://iam-policy-example.json
</code></pre></div><ol start="3">
<li>Create an IAM role and attach the IAM policy to it. Annotate the Kubernetes service account with the IAM role ARN and the IAM role with the Kubernetes service account name. You can create the role using eksctl as follows -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">eksctl create iamserviceaccount \
    --name efs-csi-controller-sa \
    --namespace kube-system \
    --cluster $CLUSTER_NAME \
    --attach-policy-arn arn:aws:iam::$AWS_ACCOUNT_ID:policy/AmazonEKS_EFS_CSI_Driver_Policy \
    --approve \
    --override-existing-serviceaccounts \
    --region $CLUSTER_REGION
</code></pre></div><ol start="4">
<li>You can verify by describing the specified service account to check if it has been correctly annotated -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl describe -n kube-system serviceaccount efs-csi-controller-sa
</code></pre></div><h4 id="3-manually-create-an-instance-of-the-efs-filesystem">3. Manually Create an Instance of the EFS Filesystem</h4>
<p>Please refer to the official <a href="https://docs.aws.amazon.com/eks/latest/userguide/efs-csi.html#efs-create-filesystem">AWS EFS CSI Document</a> for detailed instructions on creating an EFS filesystem.</p>
<p>Note: For this README, we have assumed that you are creating your EFS Filesystem in the same VPC as your EKS Cluster.</p>
<h4 id="choose-between-dynamic-and-static-provisioning">Choose between dynamic and static provisioning</h4>
<p>In the following section, you have to choose between setting up <a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">dynamic provisioning</a> or setting up static provisioning.</p>
<p>For this section, navigate to the storage directory in docs as -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">cd $GITHUB_ROOT/docs/deployment/add-ons/storage/efs
</code></pre></div><h4 id="4-option-1-dynamic-provisioning">4. [Option 1] Dynamic Provisioning</h4>
<ol>
<li>Use the <code>$file_system_id</code> you recorded in section 3 above or use the AWS Console to get the filesystem id of the EFS file system you want to use. Now edit the <code>dynamic-provisioning/sc.yaml</code> file by chaning <code>&lt;YOUR_FILE_SYSTEM_ID&gt;</code> with your <code>fs-xxxxxx</code> file system id. You can also change it using the following command :</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">file_system_id=$file_system_id yq e &#39;.parameters.fileSystemId = env(file_system_id)&#39; -i dynamic-provisioning/sc.yaml
</code></pre></div><ol start="2">
<li>Create the storage class using the following command :</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -f dynamic-provisioning/sc.yaml
</code></pre></div><ol start="3">
<li>Verify your setup by checking which storage classes are created for your cluster. You can use the following command</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl get sc
</code></pre></div><p>Note : The <code>StorageClass</code> is a cluster scoped resource which means we only need to do this step once per cluster.</p>
<h4 id="4-option-2-static-provisioning">4. [Option 2] Static Provisioning</h4>
<p><a href="https://github.com/kubernetes-sigs/aws-efs-csi-driver/tree/master/examples/kubernetes/multiple_pods">Using this sample from official AWS Docs</a> we have provided the required spec files in the sample subdirectory but you can create the PVC another way.</p>
<ol>
<li>Use the <code>$file_system_id</code> you recorded in section 3 above or use the AWS Console to get the filesystem id of the EFS file system you want to use. Now edit the last line of the static-provisioning/pv.yaml file to specify the <code>volumeHandle</code> field to point to your EFS filesystem. Replace <code>$file_system_id</code> if it is not already set.</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">file_system_id=$file_system_id yq e &#39;.spec.csi.volumeHandle = env(file_system_id)&#39; -i static-provisioning/pv.yaml
</code></pre></div><ol start="2">
<li>The <code>PersistentVolume</code> and <code>StorageClass</code> are cluster scoped resources but the <code>PersistentVolumeClaim</code> needs to be in the namespace you will be accessing it from. Replace the <code>kubeflow-user-example-com</code> namespace specified the below with the namespace for your kubeflow user and edit the <code>static-provisioning/pvc.yaml</code> file accordingly.</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export PVC_NAMESPACE=kubeflow-user-example-com
yq e &#39;.metadata.namespace = env(PVC_NAMESPACE)&#39; -i static-provisioning/pvc.yaml
</code></pre></div><ol start="3">
<li>Now create the required persistentvolume, persistentvolumeclaim and storageclass resources as -</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -f static-provisioning/sc.yaml
kubectl apply -f static-provisioning/pv.yaml
kubectl apply -f static-provisioning/pvc.yaml
</code></pre></div><ol start="4">
<li>Check your Setup
Use the following commands to ensure all resources have been deployed as expected and the PersistentVolume is correctly bound to the PersistentVolumeClaim</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl get pv

NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                 STORAGECLASS   REASON   AGE
efs-pv  5Gi        RWX            Retain           Bound    kubeflow-user-example-com/efs-claim   efs-sc                  5d16h
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl get pvc -n $PVC_NAMESPACE

NAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
efs-claim   Bound    efs-pv   5Gi        RWX            efs-sc         5d16h
</code></pre></div><p>Now, Port Forward as needed and Login to the Kubeflow dashboard. You can also check the <code>Volumes</code> tab in Kubeflow and you should be able to see your PVC is available for use within Kubeflow.
In the following two sections we will be using this PVC to create a notebook server with Amazon EFS mounted as the workspace volume, download training data into this filesystem and then deploy a TFJob to train a model using this data.</p>
<h2 id="30-using-efs-storage-in-kubeflow">3.0 Using EFS Storage in Kubeflow</h2>
<h3 id="31-set-up-the-environment">3.1 Set up the environment</h3>
<p>For the following sections, make sure to navigate back to the docs folder at the following path -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">cd $GITHUB_ROOT/docs/deployment/add-ons/storage/
</code></pre></div><p>and also export the namespace as -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export PVC_NAMESPACE=kubeflow-user-example-com
</code></pre></div><p>export the claim name you plan to use</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export CLAIM_NAME=efs-claim
</code></pre></div><h3 id="32-changing-the-default-storage-class">3.2 Changing the default Storage Class</h3>
<p>After installing Kubeflow, you can change the default Storage Class from <code>gp2</code> to the efs storage class you created during the setup. For instance, if you followed the automatic or manual steps, you should have a storage class named <code>efs-sc</code>. You can check your storage classes by running <code>kubectl get sc</code>.</p>
<p>This is can be useful if your notebook configuration is set to use the default storage class (it is the case by default). By changing the default storage class, when creating workspace volumes for your notebooks, it will use your EFS storage class automatically. This is not mandatory as you can also manually create a PVC and select the <code>efs-sc</code> class via the Volume UI but can facilitate the notebook creation process and automatically select this class when creating volume in the UI. You can also decide to keep using <code>gp2</code> for workspace volumes and keep the EFS storage class for datasets/data volumes only.</p>
<p>To learn more about how to change the default Storage Class, you can refer to the <a href="https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/#changing-the-default-storageclass">official Kubernetes documentation</a>.</p>
<p>For instance, if you have a default class set to <code>gp2</code> and another class <code>efs-sc</code>, then you would need to do the following :</p>
<ol>
<li>Remove <code>gp2</code> as your default storage class</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl patch storageclass gp2 -p &#39;{&#34;metadata&#34;: {&#34;annotations&#34;:{&#34;storageclass.kubernetes.io/is-default-class&#34;:&#34;false&#34;}}}&#39;
</code></pre></div><ol start="2">
<li>Set <code>efs-sc</code> as your default storage class</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl patch storageclass efs-sc -p &#39;{&#34;metadata&#34;: {&#34;annotations&#34;:{&#34;storageclass.kubernetes.io/is-default-class&#34;:&#34;true&#34;}}}&#39;
</code></pre></div><p>Note: As mentioned, make sure to change your default storage class only after you have completed your Kubeflow deployment. The default Kubeflow components may not work well with a different storage class.</p>
<h3 id="33-note-about-permissions">3.3 Note about Permissions</h3>
<p>This step may not be necessary but you might need to specify some additional directory permissions on your worker node before you can use these as mount points. By default, new Amazon EFS file systems are owned by root:root, and only the root user (UID 0) has read-write-execute permissions. If your containers are not running as root, you must change the Amazon EFS file system permissions to allow other users to modify the file system. The set-permission-job.yaml is an example of how you could set these permissions to be able to use the efs as your workspace in your kubeflow notebook. Modify it accordingly if you run into similar permission issues with any other job pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export CLAIM_NAME=efs-claim
yq e &#39;.metadata.name = env(CLAIM_NAME)&#39; -i notebook-sample/set-permission-job.yaml
yq e &#39;.metadata.namespace = env(PVC_NAMESPACE)&#39; -i notebook-sample/set-permission-job.yaml
yq e &#39;.spec.template.spec.volumes[0].persistentVolumeClaim.claimName = env(CLAIM_NAME)&#39; -i notebook-sample/set-permission-job.yaml

kubectl apply -f notebook-sample/set-permission-job.yaml
</code></pre></div><h3 id="34-creating-and-using-efs-volumes-as-workspace-or-data-volume-for-a-notebook-dynamic-provisioning">3.4 Creating and using EFS volumes as workspace or data volume for a notebook (Dynamic Provisioning)</h3>
<p><strong>Important : The following example only works if you setup dynamic provisioning.</strong></p>
<p>Here is an example that illustrates how to create a PVC for your dataset in <code>ReadWriteMany</code> mode meaning it can be used by many notebooks at the same time as well as how to create a notebook with a workspace volume for the notebook data and how to specify that you want to use your dataset volume as data volume.
Note that both of these volumes are created under the storage class <code>efs-sc</code> which represents the EFS storage class created earlier.</p>
<p><a href="https://user-images.githubusercontent.com/26939775/153103745-70f93ac5-88f3-4387-b40d-b585fca80af4.mp4">https://user-images.githubusercontent.com/26939775/153103745-70f93ac5-88f3-4387-b40d-b585fca80af4.mp4</a></p>
<h3 id="35-using-existing-efs-volume-as-workspace-or-data-volume-for-a-notebook-static-provisioning">3.5 Using existing EFS volume as workspace or data volume for a notebook (Static Provisioning)</h3>
<p><strong>Important : The following example only works if you setup static provisioning.</strong></p>
<p>Spin up a new Kubeflow notebook server and specify the name of the PVC to be used as the workspace volume or the data volume and specify your desired mount point. We&rsquo;ll assume you created a PVC with the name <code>efs-claim</code> via Kubeflow Volumes UI or via the manual setup step <a href="./README.md#4-option-2-static-provisioning">Static Provisioning</a>. For our example here, we are using the AWS Optimized Tensorflow 2.6 CPU image provided in the notebook configuration options - <code>public.ecr.aws/c9e4w0g3/notebook-servers/jupyter-tensorflow</code>. Additionally, use the existing <code>efs-claim</code> volume as the workspace volume at the default mount point <code>/home/jovyan</code>. The server might take a few minutes to come up.</p>
<p>In case the server does not start up in the expected time, do make sure to check -</p>
<ol>
<li>The Notebook Controller Logs</li>
<li>The specific notebook server instance pod&rsquo;s logs</li>
</ol>
<h3 id="36-using-efs-volume-for-a-trainingjob-using-tfjob-operator">3.6 Using EFS volume for a TrainingJob using TFJob Operator</h3>
<p>The following section re-uses the PVC and the Tensorflow Kubeflow Notebook created in the previous steps to download a dataset to the EFS Volume. Then we spin up a TFjob which runs a image classification job using the data from the shared volume.
Source: <a href="https://www.tensorflow.org/tutorials/load_data/images">https://www.tensorflow.org/tutorials/load_data/images</a></p>
<p>Note: The following steps are run from the terminal on your gateway node connected to your EKS cluster and not from the Kubeflow Notebook to test the PVC allowed sharing of data as expected.</p>
<h4 id="1-download-the-dataset-to-the-efs-volume">1. Download the dataset to the EFS Volume</h4>
<p>In the Kubeflow Notebook created above, use the following snippet to download the data into the <code>/home/jovyan/.keras</code> directory (which is mounted onto the EFS Volume).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">import pathlib
import tensorflow as tf
dataset_url = &#34;https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz&#34;
data_dir = tf.keras.utils.get_file(origin=dataset_url,
                                   fname=&#39;flower_photos&#39;,
                                   untar=True)
data_dir = pathlib.Path(data_dir)
</code></pre></div><h4 id="2-build-and-push-the-docker-image">2. Build and Push the Docker image</h4>
<p>In the <code>training-sample</code> directory, we have provided a sample training script and Dockerfile which you can use as follows to build a docker image. Be sure to point the <code>$IMAGE_URI</code> to your registry and specify an appropriate tag -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export IMAGE_URI=&lt;dockerimage:tag&gt;
cd training-sample

# You will need to login to ECR for the following steps
docker build -t $IMAGE_URI .
docker push $IMAGE_URI
cd -
</code></pre></div><h4 id="3-configure-the-tfjob-spec-file">3. Configure the tfjob spec file</h4>
<p>Once the docker image is built, replace the <code>&lt;dockerimage:tag&gt;</code> in the <code>tfjob.yaml</code> file, line #17.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">yq e &#39;.spec.tfReplicaSpecs.Worker.template.spec.containers[0].image = env(IMAGE_URI)&#39; -i training-sample/tfjob.yaml
</code></pre></div><p>Also, specify the name of the PVC you created -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">export CLAIM_NAME=efs-claim
yq e &#39;.spec.tfReplicaSpecs.Worker.template.spec.volumes[0].persistentVolumeClaim.claimName = env(CLAIM_NAME)&#39; -i training-sample/tfjob.yaml
</code></pre></div><p>Make sure to run it in the same namespace as the claim -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">yq e &#39;.metadata.namespace = env(PVC_NAMESPACE)&#39; -i training-sample/tfjob.yaml
</code></pre></div><h4 id="4-create-the-tfjob-and-use-the-provided-commands-to-check-the-training-logs">4. Create the TFjob and use the provided commands to check the training logs</h4>
<p>At this point, we are ready to train the model using the <code>training-sample/training.py</code> script and the data available on the shared volume with the Kubeflow TFJob operator as -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -f training-sample/tfjob.yaml
</code></pre></div><p>In order to check that the training job is running as expected, you can check the events in the TFJob describe response as well as the job logs as -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl describe tfjob image-classification-pvc -n $PVC_NAMESPACE
kubectl logs -n $PVC_NAMESPACE image-classification-pvc-worker-0 -f
</code></pre></div><h2 id="40-cleanup">4.0 Cleanup</h2>
<p>This section cleans up the resources created in this README, to cleanup other resources such as the Kubeflow deployment, please refer to the high level README files.</p>
<h3 id="41-clean-up-the-tfjob">4.1 Clean up the TFJob</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl delete tfjob -n $PVC_NAMESPACE image-classification-pvc
</code></pre></div><h3 id="42-delete-the-kubeflow-notebook">4.2 Delete the Kubeflow Notebook</h3>
<p>Login to the dashboard to stop and/or terminate any kubeflow notebooks you created for this session or use the following command -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl delete notebook -n $PVC_NAMESPACE &lt;notebook-name&gt;
</code></pre></div><p>Use the following command to delete the permissions job -</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl delete pod -n $PVC_NAMESPACE $CLAIM_NAME
</code></pre></div><h3 id="43-delete-pvc-pv-and-sc-in-the-following-order">4.3 Delete PVC, PV and SC in the following order</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl delete pvc -n $PVC_NAMESPACE $CLAIM_NAME
kubectl delete pv efs-pv
kubectl delete sc efs-sc
</code></pre></div><h3 id="44-delete-the-efs-mount-targets-filesystem-and-security-group">4.4 Delete the EFS mount targets, filesystem and security group</h3>
<p>Use the steps in this <a href="https://docs.aws.amazon.com/efs/latest/ug/delete-efs-fs.html">AWS Guide</a> to delete the EFS filesystem that you created.</p>
<h2 id="50-known-issues">5.0 Known Issues:</h2>
<ol>
<li>
<p>When you rerun the <code>eksctl create iamserviceaccount</code> to create and annotate the same service account multiple times, sometimes the role does not get overwritten. In such a case you may need to do one or both of the following -
a. Delete the cloudformation stack associated with this add-on role.
b. Delete the <code>efs-csi-controller-sa</code> service account and then re-run the required steps. If you used the auto-script, you can rerun it by specifying the same <code>filesystem-name</code> such that a new one is not created.</p>
</li>
<li>
<p>We have seen some issues when running these steps on multiple clusters sharing the same VPC.</p>
</li>
</ol>

	
		<style>
  .feedback--answer {
    display: inline-block;
  }
  .feedback--answer-no {
    margin-left: 1em;
  }
  .feedback--response {
    display: none;
    margin-top: 1em;
  }
  .feedback--response__visible {
    display: block;
  }
</style>
<div class="card mt-4 col-12 col-sm-6">
  <div class="card-body">
    <h3 class="card-title">Feedback</h3>
    <p class="card-text">Was this page helpful?</p>
    <button class="btn btn-primary feedback--answer feedback--answer-yes" style="width: 5rem;">Yes</button>
    <button class="btn btn-primary feedback--answer feedback--answer-no" style="width: 5rem;">No</button>
    <p class="feedback--response feedback--response-yes">
      Glad to hear it! Please <a href="https://github.com/awslabs/kubeflow-manifests/issues/new?assignees=&labels=documentation&template=documentation-request.md&title=">tell us how we can improve</a>.
    </p>
    <p class="feedback--response feedback--response-no">
      Sorry to hear that. Please <a href="https://github.com/awslabs/kubeflow-manifests/issues/new?assignees=&labels=documentation&template=documentation-request.md&title=">tell us how we can improve</a>.
    </p>
  </div>
</div>
<script>
  const yesButton = document.querySelector('.feedback--answer-yes');
  const noButton = document.querySelector('.feedback--answer-no');
  const yesResponse = document.querySelector('.feedback--response-yes');
  const noResponse = document.querySelector('.feedback--response-no');
  const disableButtons = () => {
    yesButton.disabled = true;
    noButton.disabled = true;
  };
  const sendFeedback = (value) => {
    if (typeof ga !== 'function') return;
    const args = {
      command: 'send',
      hitType: 'event',
      category: 'Helpful',
      action: 'click',
      label: window.location.pathname,
      value: value
    };
    ga(args.command, args.hitType, args.category, args.action, args.label, args.value);
  };
  yesButton.addEventListener('click', () => {
    yesResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(1);
  });
  noButton.addEventListener('click', () => {
    noResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(0);
  });
</script>

		<br />
	
	
	<div class="text-muted mt-5 pt-3 border-top">
  Last modified April 19, 2022: <a href="https://github.com/awslabs/kubeflow-manifests/docs/commit/cf54c93b4cfbf5c376b65f450f695077711deb84">Added Profiles component guide (cf54c93)</a>
</div>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark pt-3 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Kubeflow on AWS Authors.</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.630faeed9abb9fd07c67681cb98128bbcde59398a65eacf9e96dc1fa4461ddc2.js" integrity="sha256-Yw&#43;u7Zq7n9B8Z2gcuYEou83lk5imXqz56W3B&#43;kRh3cI=" crossorigin="anonymous"></script>




  </body>
</html>